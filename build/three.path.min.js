// github.com/shawn0326/three.path
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).THREE=t.THREE||{})}(this,(function(t){"use strict";var e=function(){function t(){this.pos=new THREE.Vector3,this.dir=new THREE.Vector3,this.right=new THREE.Vector3,this.up=new THREE.Vector3,this.dist=0,this.widthScale=1,this.sharp=!1}var e=t.prototype;return e.lerpPathPoints=function(t,e,r){this.pos.lerpVectors(t.pos,e.pos,r),this.dir.lerpVectors(t.dir,e.dir,r),this.up.lerpVectors(t.up,e.up,r),this.right.lerpVectors(t.right,e.right,r),this.dist=(e.dist-t.dist)*r+t.dist,this.widthScale=(e.widthScale-t.widthScale)*r+t.widthScale},e.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),r=new THREE.Vector3,i=new THREE.Vector3,s=new THREE.Vector3,a=new THREE.Matrix4,o=new THREE.QuadraticBezierCurve3;var n=function(){function t(){this.array=[],this.count=0}var n=t.prototype;return n.set=function(t,e,r,i,s){if(void 0===e&&(e=.1),void 0===r&&(r=10),void 0===i&&(i=null),void 0===s&&(s=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);s&&!t[0].equals(t[t.length-1])&&t.push((new THREE.Vector3).copy(t[0]));for(var a=0,o=t.length;a<o;a++)if(0===a)this._start(t[a],t[a+1],i);else if(a===o-1)if(s){this._corner(t[a],t[1],e,r,i);var n=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=n}else this._end(t[a]);else this._corner(t[a],t[a+1],e,r,i)},n.distance=function(){return this.count>0?this.array[this.count-1].dist:0},n._getByIndex=function(t){return this.array[t]||(this.array[t]=new e),this.array[t]},n._start=function(t,e,r){this.count=0;var i=this._getByIndex(this.count);if(i.pos.copy(t),i.dir.subVectors(e,t),r)i.up.copy(r);else{var s=Number.MAX_VALUE,a=Math.abs(i.dir.x),o=Math.abs(i.dir.y),n=Math.abs(i.dir.z);a<s&&(s=a,i.up.set(1,0,0)),o<s&&(s=o,i.up.set(0,1,0)),n<s&&i.up.set(0,0,1)}i.right.crossVectors(i.dir,i.up).normalize(),i.up.crossVectors(i.right,i.dir).normalize(),i.dist=0,i.widthScale=1,i.sharp=!1,i.dir.normalize(),this.count++},n._end=function(t){var e=this.array[this.count-1],i=this._getByIndex(this.count);i.pos.copy(t),i.dir.subVectors(t,e.pos);var s=i.dir.length();i.dir.normalize(),i.up.copy(e.up);var o=r.crossVectors(e.dir,i.dir);if(o.length()>Number.EPSILON){o.normalize();var n=Math.acos(Math.min(Math.max(e.dir.dot(i.dir),-1),1));i.up.applyMatrix4(a.makeRotationAxis(o,n))}i.right.crossVectors(i.dir,i.up).normalize(),i.dist=e.dist+s,i.widthScale=1,i.sharp=!1,this.count++},n._corner=function(t,e,s,a,n){if(s>0&&a>0){for(var h=function(t,e,s,a,o){var n=r.subVectors(e,t),h=i.subVectors(s,e),u=n.length(),d=h.length();return n.normalize(),h.normalize(),u>a?o.v0.copy(e).sub(n.multiplyScalar(a)):o.v0.copy(t),o.v1.copy(e),d>a?o.v2.copy(e).add(h.multiplyScalar(a)):o.v2.copy(s),o}(this.array[this.count-1].pos,t,e,s,o).getPoints(a),u=0;u<a;u++)this._sharpCorner(h[u],h[u+1],n,0===u?1:0);h[a].equals(e)||this._sharpCorner(h[a],e,n,2)}else this._sharpCorner(t,e,n,0,!0)},n._sharpCorner=function(t,e,o,n,h){void 0===n&&(n=0),void 0===h&&(h=!1);var u=this.array[this.count-1],d=this._getByIndex(this.count),c=r.subVectors(t,u.pos),p=i.subVectors(e,t),l=c.length();if(c.normalize(),p.normalize(),d.pos.copy(t),1===n?d.dir.copy(c):2===n?d.dir.copy(p):(d.dir.addVectors(c,p),d.dir.normalize()),o)1===d.dir.dot(o)?d.right.crossVectors(p,o).normalize():d.right.crossVectors(d.dir,o).normalize(),d.up.crossVectors(d.right,d.dir).normalize();else{d.up.copy(u.up);var y=s.crossVectors(u.dir,d.dir);if(y.length()>Number.EPSILON){y.normalize();var g=Math.acos(Math.min(Math.max(u.dir.dot(d.dir),-1),1));d.up.applyMatrix4(a.makeRotationAxis(y,g))}d.right.crossVectors(d.dir,d.up).normalize()}d.dist=u.dist+l;var f=c.dot(p);d.widthScale=Math.min(1/Math.sqrt((1+f)/2),1.415)||1,d.sharp=Math.abs(f-1)>.05&&h,this.count++},t}();function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var u=function(t){var r,i;function s(e,r){var i;return void 0===e&&(e=3e3),void 0===r&&(r=!1),(i=t.call(this)||this).setAttribute("position",new THREE.BufferAttribute(new Float32Array(3*e),3).setUsage(THREE.DynamicDrawUsage)),i.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(3*e),3).setUsage(THREE.DynamicDrawUsage)),i.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(2*e),2).setUsage(THREE.DynamicDrawUsage)),r&&i.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(2*e),2).setUsage(THREE.DynamicDrawUsage)),i.drawRange.start=0,i.drawRange.count=0,i.setIndex(new Array(3*e)),i}i=t,(r=s).prototype=Object.create(i.prototype),r.prototype.constructor=r,h(r,i);var a=s.prototype;return a.update=function(t,e){void 0===e&&(e={});var r=this._updateAttributes(t,e);this.drawRange.count=r},a._resizeAttribute=function(t,e){for(var r=this.getAttribute(t);r.array.length<e;){var i=r.array.length,s=new THREE.BufferAttribute(new Float32Array(2*i),r.itemSize,r.normalized);s.name=r.name,s.usage=r.usage,this.setAttribute(t,s),r=s}},a._resizeIndex=function(t){for(var e=this.getIndex();e.array.length<t;){var r=e.array.length,i=new THREE.BufferAttribute(2*r>65535?new Uint32Array(2*r):new Uint16Array(2*r),1);i.name=e.name,i.usage=e.usage,this.setIndex(i),e=i}},a._updateAttributes=function(t,r){var i=r.width||.1,s=void 0!==r.progress?r.progress:1,a=void 0===r.arrow||r.arrow,o=void 0!==r.side?r.side:"both",n=i/2,h="both"!==o?i/2:i,u=t.distance(),d=s*u;if(0==u)return 0;var c=n/h,p=n/u,l=!!this.getAttribute("uv2"),y=0,g=[],f=[],v=[],b=[],z=[],E=0,w=new THREE.Vector3,m=new THREE.Vector3,x=new THREE.Vector3,A=new THREE.Vector3,R=new THREE.Vector3,V=new THREE.Vector3;function _(t){var e=0===g.length,r=t.sharp&&!e,i=t.dist/h,s=t.dist/u,a=t.dir,d=t.up,_=t.right;if("left"!==o?w.copy(_).multiplyScalar(n*t.widthScale):w.set(0,0,0),"right"!==o?m.copy(_).multiplyScalar(-n*t.widthScale):m.set(0,0,0),w.add(t.pos),m.add(t.pos),r){x.fromArray(g,g.length-6).sub(m),A.fromArray(g,g.length-3).sub(w);var T,H,S=x.length()-A.length();S>0?(T=x,H=m):(T=A,H=w),R.copy(T).setLength(Math.abs(S)).add(H);var M=V.copy(H).sub(R).normalize().dot(a)*V.copy(H).sub(R).length()*2;V.copy(a).setLength(M).add(R),S>0?(g.push(R.x,R.y,R.z,w.x,w.y,w.z,m.x,m.y,m.z,w.x,w.y,w.z,V.x,V.y,V.z,w.x,w.y,w.z),E+=6,z.push(E-6,E-8,E-7,E-6,E-7,E-5,E-4,E-6,E-5,E-2,E-4,E-1),y+=12):(g.push(m.x,m.y,m.z,R.x,R.y,R.z,m.x,m.y,m.z,w.x,w.y,w.z,m.x,m.y,m.z,V.x,V.y,V.z),E+=6,z.push(E-6,E-8,E-7,E-6,E-7,E-5,E-6,E-5,E-3,E-2,E-3,E-1),y+=12),f.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),v.push(i-c,0,i-c,1,i,0,i,1,i+c,0,i+c,1),l&&b.push(s-p,0,s-p,1,s,0,s,1,s+p,0,s+p,1)}else g.push(m.x,m.y,m.z,w.x,w.y,w.z),f.push(d.x,d.y,d.z,d.x,d.y,d.z),v.push(i,0,i,1),l&&b.push(s,0,s,1),E+=2,e||(z.push(E-2,E-4,E-3,E-2,E-3,E-1),y+=6)}var T,H=new THREE.Vector3;if(d>0)for(var S=0;S<t.count;S++){var M=t.array[S];if(M.dist>d){var U=t.array[S-1];T=new e;var P=(d-U.dist)/(M.dist-U.dist);T.lerpPathPoints(U,M,P),_(T);break}_(M)}else T=t.array[0];a&&function(t){var e=t.dir,r=t.up,s=t.right,a=t.dist/h,d=t.dist/u;"left"!==o?w.copy(s).multiplyScalar(2*n):w.set(0,0,0),"right"!==o?m.copy(s).multiplyScalar(2*-n):m.set(0,0,0),H.copy(e).setLength(3*n),w.add(t.pos),m.add(t.pos),H.add(t.pos),g.push(m.x,m.y,m.z,w.x,w.y,w.z,H.x,H.y,H.z),f.push(r.x,r.y,r.z,r.x,r.y,r.z,r.x,r.y,r.z),v.push(a,"both"!==o?"right"!==o?-2:0:-.5,a,"both"!==o?"left"!==o?2:0:1.5,a+1.5,"both"!==o?0:.5),l&&b.push(d,"both"!==o?"right"!==o?-2:0:-.5,d,"both"!==o?"left"!==o?2:0:1.5,d+1.5*i/u,"both"!==o?0:.5),E+=3,z.push(E-1,E-3,E-2),y+=3}(T=T||t.array[t.count-1]),this._resizeAttribute("position",g.length);var I=this.getAttribute("position");I.array.set(g,0),I.updateRange.count=g.length,I.needsUpdate=!0,this._resizeAttribute("normal",f.length);var B=this.getAttribute("normal");B.array.set(f,0),B.updateRange.count=f.length,B.needsUpdate=!0,this._resizeAttribute("uv",v.length);var D=this.getAttribute("uv");if(D.array.set(v,0),D.updateRange.count=v.length,D.needsUpdate=!0,l){this._resizeAttribute("uv2",b.length);var L=this.getAttribute("uv2");L.array.set(b,0),L.updateRange.count=b.length,L.needsUpdate=!0}this._resizeIndex(z.length);var O=this.getIndex();return O.set(z,0),O.updateRange.count=z.length,O.needsUpdate=!0,y},s}(THREE.BufferGeometry),d=function(t,e){u.call(this,t||1e3,e)};d.prototype=Object.assign(Object.create(u.prototype),{constructor:d,_updateAttributes:function(t,r){var i=r.radius||.1,s=Math.max(2,r.radialSegments||8),a=r.startRad||0,o=void 0!==r.progress?r.progress:1,n=2*i*Math.PI,h=t.distance(),u=o*h;if(0==u)return 0;var d=!!this.getAttribute("uv2"),c=0,p=[],l=[],y=[],g=[],f=[],v=0,b=new THREE.Vector3;function z(t,e,r){for(var i=0===p.length,s=t.dist/n,o=t.dist/h,u=0;u<=r;u++){var z=u;z==r&&(z=0),b.copy(t.up).applyAxisAngle(t.dir,a+2*Math.PI*z/r).normalize(),p.push(t.pos.x+b.x*e*t.widthScale,t.pos.y+b.y*e*t.widthScale,t.pos.z+b.z*e*t.widthScale),l.push(b.x,b.y,b.z),y.push(s,u/r),d&&g.push(o,u/r),v++}if(!i)for(var E=v-2*(r+1),w=v-(r+1),m=0;m<r;m++)f.push(w+m,E+m,E+m+1,w+m,E+m+1,w+m+1),c+=6}if(u>0)for(var E=0;E<t.count;E++){var w=t.array[E];if(w.dist>u){var m=t.array[E-1],x=new e,A=(u-m.dist)/(w.dist-m.dist);x.lerpPathPoints(m,w,A),z(x,i,s);break}z(w,i,s)}this._resizeAttribute("position",p.length);var R=this.getAttribute("position");R.array.set(p,0),R.updateRange.count=p.length,R.needsUpdate=!0,this._resizeAttribute("normal",l.length);var V=this.getAttribute("normal");V.array.set(l,0),V.updateRange.count=l.length,V.needsUpdate=!0,this._resizeAttribute("uv",y.length);var _=this.getAttribute("uv");if(_.array.set(y,0),_.updateRange.count=y.length,_.needsUpdate=!0,d){this._resizeAttribute("uv2",g.length);var T=this.getAttribute("uv2");T.array.set(g,0),T.updateRange.count=g.length,T.needsUpdate=!0}this._resizeIndex(f.length);var H=this.getIndex();return H.set(f,0),H.updateRange.count=f.length,H.needsUpdate=!0,c}}),t.PathGeometry=u,t.PathPointList=n,t.PathTubeGeometry=d,Object.defineProperty(t,"__esModule",{value:!0})}));
