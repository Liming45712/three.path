// github.com/shawn0326/three.path
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).THREE=t.THREE||{})}(this,(function(t){"use strict";var e=function(){function t(){this.pos=new THREE.Vector3,this.dir=new THREE.Vector3,this.right=new THREE.Vector3,this.up=new THREE.Vector3,this.dist=0,this.widthScale=1,this.sharp=!1}var e=t.prototype;return e.lerpPathPoints=function(t,e,r){this.pos.lerpVectors(t.pos,e.pos,r),this.dir.lerpVectors(t.dir,e.dir,r),this.up.lerpVectors(t.up,e.up,r),this.right.lerpVectors(t.right,e.right,r),this.dist=(e.dist-t.dist)*r+t.dist,this.widthScale=(e.widthScale-t.widthScale)*r+t.widthScale},e.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),r=new THREE.Vector3,i=new THREE.Vector3,s=new THREE.Vector3,a=new THREE.Matrix4,n=new THREE.QuadraticBezierCurve3;var o=function(){function t(){this.array=[],this.count=0}var o=t.prototype;return o.set=function(t,e,r,i,s){if(void 0===e&&(e=.1),void 0===r&&(r=10),void 0===i&&(i=null),void 0===s&&(s=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);s&&!t[0].equals(t[t.length-1])&&t.push((new THREE.Vector3).copy(t[0]));for(var a=0,n=t.length;a<n;a++)if(0===a)this._start(t[a],t[a+1],i);else if(a===n-1)if(s){this._corner(t[a],t[1],e,r,i);var o=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=o}else this._end(t[a]);else this._corner(t[a],t[a+1],e,r,i)},o.distance=function(){return this.count>0?this.array[this.count-1].dist:0},o._getByIndex=function(t){return this.array[t]||(this.array[t]=new e),this.array[t]},o._start=function(t,e,r){this.count=0;var i=this._getByIndex(this.count);if(i.pos.copy(t),i.dir.subVectors(e,t),r)i.up.copy(r);else{var s=Number.MAX_VALUE,a=Math.abs(i.dir.x),n=Math.abs(i.dir.y),o=Math.abs(i.dir.z);a<s&&(s=a,i.up.set(1,0,0)),n<s&&(s=n,i.up.set(0,1,0)),o<s&&i.up.set(0,0,1)}i.right.crossVectors(i.dir,i.up).normalize(),i.up.crossVectors(i.right,i.dir).normalize(),i.dist=0,i.widthScale=1,i.sharp=!1,i.dir.normalize(),this.count++},o._end=function(t){var e=this.array[this.count-1],i=this._getByIndex(this.count);i.pos.copy(t),i.dir.subVectors(t,e.pos);var s=i.dir.length();i.dir.normalize(),i.up.copy(e.up);var n=r.crossVectors(e.dir,i.dir);if(n.length()>Number.EPSILON){n.normalize();var o=Math.acos(Math.min(Math.max(e.dir.dot(i.dir),-1),1));i.up.applyMatrix4(a.makeRotationAxis(n,o))}i.right.crossVectors(i.dir,i.up).normalize(),i.dist=e.dist+s,i.widthScale=1,i.sharp=!1,this.count++},o._corner=function(t,e,s,a,o){if(s>0&&a>0){for(var u=function(t,e,s,a,n){var o=r.subVectors(e,t),u=i.subVectors(s,e),h=o.length(),c=u.length();o.normalize(),u.normalize();var d=Math.min(h-20*Number.EPSILON,a);n.v0.copy(e).sub(o.multiplyScalar(d)),n.v1.copy(e);var p=Math.min(c/2-20*Number.EPSILON,a);return n.v2.copy(e).add(u.multiplyScalar(p)),n}(this.array[this.count-1].pos,t,e,s,n).getPoints(a),h=0;h<a;h++)this._sharpCorner(u[h],u[h+1],o,0===h?1:0);u[a].equals(e)||this._sharpCorner(u[a],e,o,2)}else this._sharpCorner(t,e,o,0,!0)},o._sharpCorner=function(t,e,n,o,u){void 0===o&&(o=0),void 0===u&&(u=!1);var h=this.array[this.count-1],c=this._getByIndex(this.count),d=r.subVectors(t,h.pos),p=i.subVectors(e,t),l=d.length();if(d.normalize(),p.normalize(),c.pos.copy(t),1===o?c.dir.copy(d):2===o?c.dir.copy(p):(c.dir.addVectors(d,p),c.dir.normalize()),n)1===c.dir.dot(n)?c.right.crossVectors(p,n).normalize():c.right.crossVectors(c.dir,n).normalize(),c.up.crossVectors(c.right,c.dir).normalize();else{c.up.copy(h.up);var y=s.crossVectors(h.dir,c.dir);if(y.length()>Number.EPSILON){y.normalize();var g=Math.acos(Math.min(Math.max(h.dir.dot(c.dir),-1),1));c.up.applyMatrix4(a.makeRotationAxis(y,g))}c.right.crossVectors(c.dir,c.up).normalize()}c.dist=h.dist+l;var f=d.dot(p);c.widthScale=Math.min(1/Math.sqrt((1+f)/2),1.415)||1,c.sharp=Math.abs(f-1)>.05&&u,this.count++},t}();function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,h(t,e)}function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var c=function(t){function e(e,r){var i;return void 0===e&&(e=3e3),void 0===r&&(r=!1),i=t.call(this)||this,isNaN(e)?i._initByData(e.pathPointList,e.options,e.usage,r):i._initByMaxVertex(e,r),i}u(e,t);var r=e.prototype;return r._initByMaxVertex=function(t,e){this.setAttribute("position",new THREE.BufferAttribute(new Float32Array(3*t),3).setUsage(THREE.DynamicDrawUsage)),this.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(3*t),3).setUsage(THREE.DynamicDrawUsage)),this.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(2*t),2).setUsage(THREE.DynamicDrawUsage)),e&&this.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(2*t),2).setUsage(THREE.DynamicDrawUsage)),this.drawRange.start=0,this.drawRange.count=0,this.setIndex(new Array(3*t))},r._initByData=function(t,e,r,i){void 0===e&&(e={});var s=d(t,e,i);s&&0!==s.count?(this.setAttribute("position",new THREE.BufferAttribute(new Float32Array(s.position),3).setUsage(r||THREE.StaticDrawUsage)),this.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(s.normal),3).setUsage(r||THREE.StaticDrawUsage)),this.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(s.uv),2).setUsage(r||THREE.StaticDrawUsage)),i&&this.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(s.uv2),2).setUsage(r||THREE.StaticDrawUsage)),this.setIndex(s.indices)):this._initByMaxVertex(2,i)},r.update=function(t,e){void 0===e&&(e={});var r=!!this.getAttribute("uv2"),i=d(t,e,r);i?(this._updateAttributes(i.position,i.normal,i.uv,r?i.uv2:null,i.indices),this.drawRange.count=i.count):this.drawRange.count=0},r._resizeAttribute=function(t,e){for(var r=this.getAttribute(t);r.array.length<e;){var i=r.array.length,s=new THREE.BufferAttribute(new Float32Array(2*i),r.itemSize,r.normalized);s.name=r.name,s.usage=r.usage,this.setAttribute(t,s),r=s}},r._resizeIndex=function(t){for(var e=this.getIndex();e.array.length<t;){var r=e.array.length,i=new THREE.BufferAttribute(2*r>65535?new Uint32Array(2*r):new Uint16Array(2*r),1);i.name=e.name,i.usage=e.usage,this.setIndex(i),e=i}},r._updateAttributes=function(t,e,r,i,s){this._resizeAttribute("position",t.length);var a=this.getAttribute("position");a.array.set(t,0),a.updateRange.count=t.length,a.needsUpdate=!0,this._resizeAttribute("normal",e.length);var n=this.getAttribute("normal");n.array.set(e,0),n.updateRange.count=e.length,n.needsUpdate=!0,this._resizeAttribute("uv",r.length);var o=this.getAttribute("uv");if(o.array.set(r,0),o.updateRange.count=r.length,o.needsUpdate=!0,i){this._resizeAttribute("uv2",i.length);var u=this.getAttribute("uv2");u.array.set(i,0),u.updateRange.count=i.length,u.needsUpdate=!0}this._resizeIndex(s.length);var h=this.getIndex();h.set(s,0),h.updateRange.count=s.length,h.needsUpdate=!0},e}(THREE.BufferGeometry);function d(t,r,i){void 0===i&&(i=!1);var s=r.width||.1,a=void 0!==r.progress?r.progress:1,n=void 0===r.arrow||r.arrow,o=void 0!==r.side?r.side:"both",u=s/2,h="both"!==o?s/2:s,c=t.distance(),d=a*c;if(0==c)return null;var p=u/h,l=u/c,y=0,g=[],f=[],v=[],E=[],w=[],b=0,m=new THREE.Vector3,A=new THREE.Vector3,x=new THREE.Vector3,R=new THREE.Vector3,z=new THREE.Vector3,T=new THREE.Vector3;function H(t){var e=0===g.length,r=t.sharp&&!e,s=t.dist/h,a=t.dist/c,n=t.dir,d=t.up,H=t.right;if("left"!==o?m.copy(H).multiplyScalar(u*t.widthScale):m.set(0,0,0),"right"!==o?A.copy(H).multiplyScalar(-u*t.widthScale):A.set(0,0,0),m.add(t.pos),A.add(t.pos),r){x.fromArray(g,g.length-6).sub(A),R.fromArray(g,g.length-3).sub(m);var V,_,S=x.length()-R.length();S>0?(V=x,_=A):(V=R,_=m),z.copy(V).setLength(Math.abs(S)).add(_);var U=T.copy(_).sub(z).normalize().dot(n)*T.copy(_).sub(z).length()*2;T.copy(n).setLength(U).add(z),S>0?(g.push(z.x,z.y,z.z,m.x,m.y,m.z,A.x,A.y,A.z,m.x,m.y,m.z,T.x,T.y,T.z,m.x,m.y,m.z),b+=6,w.push(b-6,b-8,b-7,b-6,b-7,b-5,b-4,b-6,b-5,b-2,b-4,b-1),y+=12):(g.push(A.x,A.y,A.z,z.x,z.y,z.z,A.x,A.y,A.z,m.x,m.y,m.z,A.x,A.y,A.z,T.x,T.y,T.z),b+=6,w.push(b-6,b-8,b-7,b-6,b-7,b-5,b-6,b-5,b-3,b-2,b-3,b-1),y+=12),f.push(d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z,d.x,d.y,d.z),v.push(s-p,0,s-p,1,s,0,s,1,s+p,0,s+p,1),i&&E.push(a-l,0,a-l,1,a,0,a,1,a+l,0,a+l,1)}else g.push(A.x,A.y,A.z,m.x,m.y,m.z),f.push(d.x,d.y,d.z,d.x,d.y,d.z),v.push(s,0,s,1),i&&E.push(a,0,a,1),b+=2,e||(w.push(b-2,b-4,b-3,b-2,b-3,b-1),y+=6)}var V,_=new THREE.Vector3;if(d>0)for(var S=0;S<t.count;S++){var U=t.array[S];if(U.dist>d){var B=t.array[S-1];V=new e;var M=(d-B.dist)/(U.dist-B.dist);V.lerpPathPoints(B,U,M),H(V);break}H(U)}else V=t.array[0];return n&&function(t){var e=t.dir,r=t.up,a=t.right,n=t.dist/h,d=t.dist/c;"left"!==o?m.copy(a).multiplyScalar(2*u):m.set(0,0,0),"right"!==o?A.copy(a).multiplyScalar(2*-u):A.set(0,0,0),_.copy(e).setLength(3*u),m.add(t.pos),A.add(t.pos),_.add(t.pos),g.push(A.x,A.y,A.z,m.x,m.y,m.z,_.x,_.y,_.z),f.push(r.x,r.y,r.z,r.x,r.y,r.z,r.x,r.y,r.z),v.push(n,"both"!==o?"right"!==o?-2:0:-.5,n,"both"!==o?"left"!==o?2:0:1.5,n+1.5,"both"!==o?0:.5),i&&E.push(d,"both"!==o?"right"!==o?-2:0:-.5,d,"both"!==o?"left"!==o?2:0:1.5,d+1.5*s/c,"both"!==o?0:.5),b+=3,w.push(b-1,b-3,b-2),y+=3}(V=V||t.array[t.count-1]),{position:g,normal:f,uv:v,uv2:E,indices:w,count:y}}var p=function(t){function e(e,r){return void 0===e&&(e=1e3),void 0===r&&(r=!1),t.call(this,e,r)||this}u(e,t);var r=e.prototype;return r._initByData=function(t,e,r,i){void 0===e&&(e={});var s=l(t,e,i);s&&0!==s.count?(this.setAttribute("position",new THREE.BufferAttribute(new Float32Array(s.position),3).setUsage(r||THREE.StaticDrawUsage)),this.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(s.normal),3).setUsage(r||THREE.StaticDrawUsage)),this.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(s.uv),2).setUsage(r||THREE.StaticDrawUsage)),i&&this.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(s.uv2),2).setUsage(r||THREE.StaticDrawUsage)),this.setIndex(s.indices)):this._initByMaxVertex(2,i)},r.update=function(t,e){void 0===e&&(e={});var r=!!this.getAttribute("uv2"),i=l(t,e,r);i?(this._updateAttributes(i.position,i.normal,i.uv,r?i.uv2:null,i.indices),this.drawRange.count=i.count):this.drawRange.count=0},e}(c);function l(t,r,i){void 0===i&&(i=!1);var s=r.radius||.1,a=void 0!==r.progress?r.progress:1,n=Math.max(2,r.radialSegments||8),o=r.startRad||0,u=2*s*Math.PI,h=t.distance(),c=a*h;if(0==c)return null;var d=0,p=[],l=[],y=[],g=[],f=[],v=0,E=new THREE.Vector3;function w(t,e,r){for(var s=0===p.length,a=t.dist/u,n=t.dist/h,c=0;c<=r;c++){var w=c;w==r&&(w=0),E.copy(t.up).applyAxisAngle(t.dir,o+2*Math.PI*w/r).normalize(),p.push(t.pos.x+E.x*e*t.widthScale,t.pos.y+E.y*e*t.widthScale,t.pos.z+E.z*e*t.widthScale),l.push(E.x,E.y,E.z),y.push(a,c/r),i&&g.push(n,c/r),v++}if(!s)for(var b=v-2*(r+1),m=v-(r+1),A=0;A<r;A++)f.push(m+A,b+A,b+A+1,m+A,b+A+1,m+A+1),d+=6}if(c>0)for(var b=0;b<t.count;b++){var m=t.array[b];if(m.dist>c){var A=t.array[b-1],x=new e,R=(c-A.dist)/(m.dist-A.dist);x.lerpPathPoints(A,m,R),w(x,s,n);break}w(m,s,n)}return{position:p,normal:l,uv:y,uv2:g,indices:f,count:d}}t.PathGeometry=c,t.PathPointList=o,t.PathTubeGeometry=p,Object.defineProperty(t,"__esModule",{value:!0})}));
